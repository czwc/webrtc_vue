# 辅流静音音轨插入 - 任务清单

## 任务概述

本文档将设计方案分解为具体的实施任务，每个任务都是独立可执行的单元。

## 任务列表

### ✅ Task 1: 创建静音音轨生成方法

**优先级**: P0 (最高)  
**预计时间**: 30分钟  
**依赖**: 无

**描述**: 在 `src/utils/room.js` 中添加 `createSilentAudioTrack()` 方法，用于创建静音音频轨道。

**实施步骤**:

1. 在 `room.js` 的 Room 类中添加新方法
2. 实现AudioContext创建逻辑
3. 实现振荡器和媒体流目标连接
4. 设置轨道为禁用状态
5. 存储AudioContext引用
6. 添加错误处理
7. 添加日志输出

**验收标准**:
- [ ] 方法返回有效的MediaStreamTrack对象
- [ ] 轨道类型为'audio'
- [ ] 轨道enabled属性为false
- [ ] 轨道包含_silentAudioContext引用
- [ ] 创建失败时返回null
- [ ] 有适当的日志输出

**代码位置**: `src/utils/room.js` - Room类中（建议放在 `mixAudioStream()` 方法附近）

---

### ✅ Task 2: 修改辅流推送方法添加音轨检测

**优先级**: P0 (最高)  
**预计时间**: 30分钟  
**依赖**: Task 1

**描述**: 修改 `publishAuxiliaryStream()` 方法，在推流前检测是否有音轨，如果没有则添加静音轨道。

**实施步骤**:

1. 定位 `publishAuxiliaryStream()` 方法
2. 在 `mixAudioStream()` 调用之前添加音轨检测逻辑
3. 调用 `createSilentAudioTrack()` 创建静音轨道
4. 使用 `stream.addTrack()` 添加轨道到流中
5. 标记轨道为自动添加（`_isAutoAddedSilent = true`）
6. 添加日志输出
7. 添加降级处理（创建失败时继续推流）

**验收标准**:
- [ ] 无音轨的流会自动添加静音轨道
- [ ] 有音轨的流不会添加静音轨道
- [ ] 静音轨道被正确标记
- [ ] 创建失败不影响推流流程
- [ ] 有详细的日志输出

**代码位置**: `src/utils/room.js` - `publishAuxiliaryStream()` 方法（约第1986行）

**修改示例**:
```javascript
async publishAuxiliaryStream(stream) {
    // ... 现有的清理逻辑 ...
    
    // 检查辅流是否有音轨
    if (stream && stream.getAudioTracks().length === 0) {
        console.log('[辅流] 检测到无音轨，尝试添加静音音轨');
        const silentTrack = this.createSilentAudioTrack();
        
        if (silentTrack) {
            stream.addTrack(silentTrack);
            silentTrack._isAutoAddedSilent = true;
            console.log('[辅流] 静音音轨已添加');
        } else {
            console.warn('[辅流] 静音音轨创建失败，继续使用无音轨的流');
        }
    }
    
    // ... 继续原有逻辑 ...
}
```

---

### ✅ Task 3: 添加资源清理逻辑

**优先级**: P0 (最高)  
**预计时间**: 20分钟  
**依赖**: Task 1, Task 2

**描述**: 在停止辅流时清理静音轨道的AudioContext资源，防止内存泄漏。

**实施步骤**:

1. 定位 `publishAuxiliaryStream()` 方法开始处的清理逻辑
2. 在停止轨道前检查是否为自动添加的静音轨道
3. 如果是，关闭AudioContext
4. 添加错误处理
5. 添加日志输出

**验收标准**:
- [ ] 静音轨道的AudioContext被正确关闭
- [ ] 清理失败不影响其他轨道的停止
- [ ] 有适当的日志输出
- [ ] 无内存泄漏

**代码位置**: `src/utils/room.js` - `publishAuxiliaryStream()` 方法开始处

**修改示例**:
```javascript
async publishAuxiliaryStream(stream) {
    // 停止之前的辅流轨道（包括清理静音轨道）
    if (this.screenStream) {
        this.screenStream.getTracks().forEach((track) => {
            // 如果是自动添加的静音轨道，清理AudioContext
            if (track._isAutoAddedSilent && track._silentAudioContext) {
                try {
                    track._silentAudioContext.close();
                    console.log('[辅流] 静音音轨AudioContext已清理');
                } catch (error) {
                    console.error('[辅流] 清理AudioContext失败:', error);
                }
            }
            track.stop();
        });
    }
    
    // ... 继续原有逻辑 ...
}
```

---

### ✅ Task 4: 本地功能测试

**优先级**: P0 (最高)  
**预计时间**: 1小时  
**依赖**: Task 1, Task 2, Task 3

**描述**: 在本地环境进行功能测试，验证静音轨道插入功能正常工作。

**测试用例**:

1. **测试用例1: 屏幕共享（无音频）**
   - 操作: 发起屏幕共享，不勾选"共享系统音频"
   - 预期: 
     - 控制台输出"检测到无音轨"
     - 控制台输出"静音音轨已添加"
     - 推流成功
     - 接收端能看到画面

2. **测试用例2: 屏幕共享（有音频）**
   - 操作: 发起屏幕共享，勾选"共享系统音频"
   - 预期:
     - 不输出"检测到无音轨"
     - 使用原始音轨
     - 推流成功
     - 接收端能听到系统音频

3. **测试用例3: 多次推流**
   - 操作: 连续3次发起和停止屏幕共享
   - 预期:
     - 每次都正常推流
     - 控制台输出"AudioContext已清理"
     - 无错误信息

4. **测试用例4: 快速切换**
   - 操作: 快速停止和重新开始屏幕共享
   - 预期:
     - 不出现错误
     - 资源正确清理
     - 推流正常

**验收标准**:
- [ ] 所有测试用例通过
- [ ] 无控制台错误
- [ ] 功能符合预期

---

### ✅ Task 5: 浏览器兼容性测试

**优先级**: P1 (高)  
**预计时间**: 1小时  
**依赖**: Task 4

**描述**: 在不同浏览器中测试功能兼容性。

**测试浏览器**:

1. **Chrome (最新版)**
   - 测试屏幕共享（无音频）
   - 测试屏幕共享（有音频）
   - 验证推流正常

2. **Firefox (最新版)**
   - 测试屏幕共享（无音频）
   - 测试屏幕共享（有音频）
   - 验证推流正常

3. **Edge (最新版)**
   - 测试屏幕共享（无音频）
   - 测试屏幕共享（有音频）
   - 验证推流正常

4. **Safari (如果可用)**
   - 测试屏幕共享（无音频）
   - 测试屏幕共享（有音频）
   - 验证推流正常

**验收标准**:
- [ ] Chrome测试通过
- [ ] Firefox测试通过
- [ ] Edge测试通过
- [ ] Safari测试通过（如适用）
- [ ] 记录任何兼容性问题

---

### ✅ Task 6: 回归测试

**优先级**: P0 (最高)  
**预计时间**: 1小时  
**依赖**: Task 4

**描述**: 验证修改不影响其他功能。

**测试项目**:

1. **主流推送功能**
   - 操作: 开启摄像头和麦克风推流
   - 预期: 功能正常，不受影响

2. **白板共享功能**
   - 操作: 发起白板共享
   - 预期: 功能正常，不受影响

3. **录制功能**
   - 操作: 开启录制功能
   - 预期: 录制正常，音视频同步

4. **音频混流功能**
   - 操作: 测试音频混流相关功能
   - 预期: 功能正常，不受影响

5. **多人连接**
   - 操作: 多个用户同时连接
   - 预期: 所有用户推拉流正常

**验收标准**:
- [ ] 主流推送正常
- [ ] 白板共享正常
- [ ] 录制功能正常
- [ ] 音频混流正常
- [ ] 多人连接正常
- [ ] 无新增bug

---

### ✅ Task 7: 性能测试

**优先级**: P2 (中)  
**预计时间**: 30分钟  
**依赖**: Task 4

**描述**: 验证静音轨道不会造成明显的性能影响。

**测试指标**:

1. **CPU使用率**
   - 测试前: 记录基准CPU使用率
   - 测试中: 开启屏幕共享（无音频）
   - 测试后: 对比CPU使用率变化
   - 预期: 增加不超过5%

2. **内存使用**
   - 测试前: 记录基准内存使用
   - 测试中: 开启屏幕共享（无音频）
   - 测试后: 对比内存使用变化
   - 预期: 增加不超过10MB

3. **带宽消耗**
   - 使用浏览器开发工具监控网络流量
   - 对比有音轨和无音轨（静音）的带宽差异
   - 预期: 静音轨道带宽消耗可忽略

**验收标准**:
- [ ] CPU增加在可接受范围内
- [ ] 内存增加在可接受范围内
- [ ] 带宽消耗在可接受范围内
- [ ] 无明显性能下降

---

### ✅ Task 8: 代码审查和优化

**优先级**: P1 (高)  
**预计时间**: 30分钟  
**依赖**: Task 1, Task 2, Task 3

**描述**: 审查代码质量，添加注释，优化实现。

**审查项目**:

1. **代码规范**
   - 检查代码风格是否一致
   - 检查变量命名是否清晰
   - 检查缩进和格式

2. **注释完整性**
   - 为 `createSilentAudioTrack()` 添加JSDoc注释
   - 为关键逻辑添加行内注释
   - 说明为什么需要静音轨道

3. **错误处理**
   - 检查所有可能的错误点
   - 确保有适当的try-catch
   - 确保错误不会中断主流程

4. **日志输出**
   - 检查日志级别是否合适
   - 确保日志信息清晰有用
   - 避免过多的日志输出

**验收标准**:
- [ ] 代码符合项目规范
- [ ] 注释完整清晰
- [ ] 错误处理完善
- [ ] 日志输出合理

---

### ✅ Task 9: 文档更新

**优先级**: P2 (中)  
**预计时间**: 20分钟  
**依赖**: Task 8

**描述**: 更新相关文档，记录修改内容。

**文档更新项**:

1. **代码注释**
   - 在 `publishAuxiliaryStream()` 方法上方添加说明
   - 说明静音轨道插入的目的和时机

2. **变更日志**（如果项目有）
   - 记录新增功能
   - 记录修改的方法

3. **README或使用文档**（如果需要）
   - 说明辅流推送的新特性
   - 说明静音轨道的作用

**验收标准**:
- [ ] 代码注释完整
- [ ] 变更日志已更新（如适用）
- [ ] 使用文档已更新（如适用）

---

## 任务执行顺序

```
Task 1 (创建静音音轨方法)
    ↓
Task 2 (修改辅流推送方法)
    ↓
Task 3 (添加资源清理)
    ↓
Task 4 (本地功能测试) ← 必须通过才能继续
    ↓
    ├─→ Task 5 (浏览器兼容性测试)
    ├─→ Task 6 (回归测试) ← 必须通过
    └─→ Task 7 (性能测试)
    ↓
Task 8 (代码审查和优化)
    ↓
Task 9 (文档更新)
```

## 风险和注意事项

### 关键风险点

1. **AudioContext限制**
   - 某些浏览器可能限制AudioContext数量
   - 缓解: 屏幕共享需要用户交互，满足条件

2. **资源泄漏**
   - AudioContext未正确关闭可能导致内存泄漏
   - 缓解: Task 3专门处理资源清理

3. **兼容性问题**
   - Safari可能需要webkit前缀
   - 缓解: 代码中已处理兼容性

### 测试重点

- ✓ 无音轨场景（最重要）
- ✓ 有音轨场景（确保不影响）
- ✓ 资源清理（防止泄漏）
- ✓ 回归测试（确保不影响其他功能）

## 完成标准

所有任务的验收标准都满足，且：

- [ ] 代码已提交到版本控制
- [ ] 所有测试通过
- [ ] 代码审查通过
- [ ] 文档已更新
- [ ] 无已知bug

## 预计总时间

- 开发时间: 1.5小时 (Task 1-3)
- 测试时间: 2.5小时 (Task 4-7)
- 优化和文档: 0.5小时 (Task 8-9)
- **总计**: 约4.5小时

## 后续优化（可选）

这些任务不在当前范围内，但可以作为未来改进：

1. **AudioContext复用**
   - 优化: 复用AudioContext而不是每次创建
   - 收益: 减少资源消耗

2. **配置化**
   - 优化: 添加配置项控制是否启用静音轨道
   - 收益: 更灵活的控制

3. **监控和统计**
   - 优化: 添加使用统计和性能监控
   - 收益: 了解功能使用情况

